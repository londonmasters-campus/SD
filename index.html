<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>London Masters Campus - Student Verification</title>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<style>
:root{
  --dark-blue:#001f3f;
  --brand-red:#ff0000;
  --white:#ffffff;
}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:var(--dark-blue);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.container{
  width:100%;
  max-width:450px;
  background:#fff;
  border-radius:20px;
  overflow:hidden;
  box-shadow:0 15px 35px rgba(0,0,0,.4);
}
.banner{
  background:#fff;
  padding:25px 15px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:15px;
  border-bottom:2px solid #f0f0f0;
}
.banner img{height:80px}
.banner h1{
  font-size:24px;
  margin:0;
  background:linear-gradient(to right,var(--dark-blue),var(--brand-red),var(--dark-blue));
  background-size:200%;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  animation:move 3s linear infinite;
}
@keyframes move{0%{background-position:200%}100%{background-position:0%}}

.form-content{padding:25px 20px}
label{font-weight:600;font-size:14px;color:#333}
input,select{
  width:100%;
  padding:14px;
  margin:8px 0 18px;
  border:1px solid #b0bec5;
  border-radius:10px;
  font-size:15px;
}
button{
  width:100%;
  padding:16px;
  border:none;
  border-radius:10px;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}
#verifyBtn{background:var(--brand-red);color:#fff}
#submitBtn{background:var(--dark-blue);color:#fff}
#otpBtn{background:#28a745;color:#fff}
.hidden{display:none}

.stars{display:flex;justify-content:center;gap:10px;margin-bottom:20px}
.stars input{display:none}
.stars label{font-size:30px;color:#ccc;cursor:pointer}
.stars input:checked~label,
.stars label:hover,
.stars label:hover~label{color:#ffcc00}

/* POPUP AD */
#adOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
#adBox{
  background:#fff;
  border-radius:15px;
  padding:10px;
  position:relative;
  max-width:90%;
}
#adBox img{width:100%;border-radius:10px}
#adClose{
  position:absolute;
  top:5px;
  right:10px;
  font-size:22px;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="adOverlay">
  <div id="adBox">
    <div id="adClose" onclick="closeAd()">✖</div>
    <img src="assets/ad_1080.webp" alt="Ad">
  </div>
</div>

<div class="container">
  <div class="banner">
    <img src="assets/logo.png">
    <h1>London Masters Campus</h1>
  </div>

  <div class="form-content">

    <!-- STEP 1 -->
    <div id="step1">
      <label>Course Name</label>
      <select id="course">
        <option value="MDRT">Breaking Barriers for MDRT 2026</option>
        <option value="Bathiya">Reset & Rebuild 2026</option>
      </select>

      <label>Mobile Number</label>
      <input id="mobile" placeholder="07xxxxxxxx" maxlength="10">
      <div style="color:red;font-size:12px">
        කරුණාකර ඔබ රෙජිස්ටර් වූ දුරකථන අංකය පමණක් භාවිතා කරන්න.
      </div>

      <button id="verifyBtn" onclick="verifyMobile()">Verify Mobile</button>
    </div>

    <!-- ALREADY REGISTERED -->
    <div id="existing" class="hidden">
      <p><b>ඔබ දැනටමත් ලියාපදිංචි වී ඇත.</b></p>
      <p>Email: <span id="oldEmail"></span></p>

      <button onclick="continueSame()">Continue with same email</button>
      <button style="margin-top:10px;background:#555;color:#fff" onclick="changeEmail()">Change email</button>
    </div>

    <!-- DETAILS -->
    <div id="details" class="hidden">
      <label>Full Name</label>
      <input id="fullName">

      <label>Gmail Address</label>
      <input id="gmail">

      <label>Nearest City</label>
      <input id="city">

      <label>Rate the Programme</label>
      <div class="stars">
        <input type="radio" id="s5" name="r" value="5"><label for="s5">★</label>
        <input type="radio" id="s4" name="r" value="4"><label for="s4">★</label>
        <input type="radio" id="s3" name="r" value="3"><label for="s3">★</label>
        <input type="radio" id="s2" name="r" value="2"><label for="s2">★</label>
        <input type="radio" id="s1" name="r" value="1"><label for="s1">★</label>
      </div>

      <button id="submitBtn" onclick="submitForm(false)">Submit & Send OTP</button>
    </div>

    <!-- OTP -->
    <div id="otp" class="hidden">
      <label>Enter OTP</label>
      <input id="otpInput" maxlength="6" style="text-align:center;font-size:22px">
      <button id="otpBtn" onclick="verifyOTP()">Verify & Download</button>
    </div>

    <!-- SUCCESS -->
    <div id="success" class="hidden" style="text-align:center">
      <h2 style="color:green">Success!</h2>
      <a id="download" target="_blank">Download Certificate</a>
    </div>

  </div>
</div>

<script>
const scriptUrl = "https://script.google.com/macros/s/AKfycbwnusPahEzNBV3ZJOLPfk0hHmxKHe91Fy4RiEmZMJl5NqZL_uggL-bUQbHzd8jeo_LI/exec";

let cachedName = "";

function verifyMobile(){
  fetch(`${scriptUrl}?action=verify&mobile=${mobile.value}&course=${course.value}`)
  .then(r=>r.json()).then(d=>{
    if(d.status==="new_user"){
      step1.classList.add("hidden");
      details.classList.remove("hidden");
      showAd();
    }
    if(d.status==="already_submitted"){
      cachedName = d.name;
      oldEmail.innerText = d.email;
      step1.classList.add("hidden");
      existing.classList.remove("hidden");
      showAd();
    }
    if(d.status==="not_registered"){
      alert("ඔබ මෙම පාඨමාලාව සඳහා ලියාපදිංචි වී නොමැත.");
    }
  });
}

function continueSame(){
  submitForm(false,true);
}

function changeEmail(){
  existing.classList.add("hidden");
  details.classList.remove("hidden");
  fullName.value = cachedName;
}

function submitForm(replace,skipDetails){
  const params = new URLSearchParams({
    action:"submit",
    mobile:mobile.value,
    course:course.value,
    name: fullName.value || cachedName,
    email:gmail.value || oldEmail.innerText,
    city:city.value,
    rating:document.querySelector('input[name="r"]:checked')?.value||"",
    replace:replace
  });
  fetch(`${scriptUrl}?${params}`)
  .then(r=>r.json()).then(()=>{
    details.classList.add("hidden");
    existing.classList.add("hidden");
    otp.classList.remove("hidden");
  });
}

function verifyOTP(){
  fetch(`${scriptUrl}?action=verifyOTP&email=${gmail.value||oldEmail.innerText}&otp=${otpInput.value}&course=${course.value}&name=${fullName.value||cachedName}`)
  .then(r=>r.json()).then(d=>{
    if(d.status==="success"){
      confetti();
      otp.classList.add("hidden");
      success.classList.remove("hidden");
      download.href=d.url;
      download.innerText="Download PDF";
    }else{
      alert("OTP වැරදියි හෝ කල් ඉකුත් වී ඇත.");
    }
  });
}

function showAd(){
  setTimeout(()=>adOverlay.style.display="flex",500);
}
function closeAd(){
  adOverlay.style.display="none";
}
</script>

</body>
</html>
